# 架構圖

## 數據流程架構

```
┌─────────────────────────────────────────────────────────────────┐
│                         用戶界面 (React App)                      │
│                          src/App.jsx                            │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 調用
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    merchantsApi 服務層                           │
│                 src/services/merchantsApi.js                    │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  獲取數據策略 (按優先級):                                  │  │
│  │  1️⃣  AWS API Gateway (優先)                              │  │
│  │  2️⃣  內存緩存 (5分鐘有效期)                               │  │
│  │  3️⃣  本地 JSON (fallback)                                │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ HTTPS Request
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   AWS API Gateway                               │
│            /merchants, /merchants/:id                           │
│                                                                 │
│  • CORS 配置                                                    │
│  • API Key (可選)                                               │
│  • 速率限制                                                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 觸發
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AWS Lambda 函數                              │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ getMerchants │  │getMerchantById│ │createMerchant│          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
│         └───────────────┬──┴───────────────┘                   │
└─────────────────────────┼────────────────────────────────────────┘
                          │
                          │ SDK 調用
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DynamoDB 表                                │
│                    Table: Merchants                             │
│                                                                 │
│  ┌────────────┬────────────┬──────────┬──────────────────┐     │
│  │ merchantId │ name       │ name_en  │ logo             │     │
│  │ (Primary)  │ (String)   │ (String) │ (String)         │     │
│  ├────────────┼────────────┼──────────┼──────────────────┤     │
│  │ parknshop  │ 百佳       │ PARKnSHOP│ https://...      │     │
│  │ wellcome   │ 惠康       │ Wellcome │ https://...      │     │
│  │ mannings   │ 萬寧       │ Mannings │ https://...      │     │
│  └────────────┴────────────┴──────────┴──────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

## 部署架構

```
┌─────────────────────────────────────────────────────────────────┐
│                      開發者本地環境                              │
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │  Source Code │    │  CDK Code    │    │  .env 配置   │     │
│  │  (React App) │    │  (IaC)       │    │              │     │
│  └──────┬───────┘    └──────┬───────┘    └──────────────┘     │
└─────────┼────────────────────┼──────────────────────────────────┘
          │                    │
          │ npm start          │ cdk deploy
          │                    │
          ▼                    ▼
┌─────────────────┐  ┌──────────────────────────────────────────┐
│  本地開發服務器  │  │         AWS Cloud                        │
│  localhost:3000 │  │                                          │
└─────────────────┘  │  ┌────────────────┐                      │
                     │  │  CloudFormation │ 創建/管理資源        │
                     │  └────────┬───────┘                      │
                     │           │                              │
                     │           ▼                              │
                     │  ┌────────────────────────────────────┐  │
                     │  │  API Gateway                       │  │
                     │  ├────────────────────────────────────┤  │
                     │  │  Lambda Functions                  │  │
                     │  ├────────────────────────────────────┤  │
                     │  │  DynamoDB                          │  │
                     │  ├────────────────────────────────────┤  │
                     │  │  CloudWatch Logs                   │  │
                     │  └────────────────────────────────────┘  │
                     └──────────────────────────────────────────┘
```

## 數據遷移流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    本地 JSON 文件                                │
│              src/data/merchants.json                            │
│                                                                 │
│  [                                                              │
│    { "name": "百佳", "name_en": "PARKnSHOP", ... },             │
│    { "name": "惠康", "name_en": "Wellcome", ... },              │
│    ...                                                          │
│  ]                                                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 1. 讀取 JSON
                         │ 2. 轉換格式 (添加 merchantId)
                         │ 3. BatchWrite
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              遷移腳本 (migrate-merchants.js)                     │
│                                                                 │
│  1. 讀取本地 JSON                                               │
│  2. 生成 merchantId (name_en → lowercase_with_underscore)       │
│  3. 添加時間戳 (createdAt, updatedAt)                           │
│  4. 分批寫入 DynamoDB (每批 25 項)                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ AWS SDK BatchWrite
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DynamoDB 表                                │
│                    (完成遷移)                                    │
│                                                                 │
│  18 個商家記錄                                                   │
│  ✅ parknshop                                                   │
│  ✅ wellcome                                                    │
│  ✅ mannings                                                    │
│  ✅ watsons                                                     │
│  ...                                                            │
└─────────────────────────────────────────────────────────────────┘
```

## API 請求流程

```
┌─────────────┐
│   用戶操作   │
│ (打開應用)  │
└──────┬──────┘
       │
       │ useEffect 觸發
       ▼
┌──────────────────────────────────────┐
│ merchantsApi.getAllMerchants()       │
└──────┬───────────────────────────────┘
       │
       │ 1. 檢查緩存
       ▼
┌──────────────┐
│ 緩存有效?    │───Yes───┐
└──────┬───────┘         │
       │ No              │
       ▼                 │
┌──────────────────────┐ │
│ fetch(API_URL)       │ │
└──────┬───────────────┘ │
       │                 │
       │ 2. API 請求      │
       ▼                 │
┌──────────────┐         │
│ API 成功?    │───No────┤
└──────┬───────┘         │
       │ Yes             │
       ▼                 │
┌──────────────────┐     │
│ 更新緩存         │     │
│ 返回數據         │◄────┘
└──────┬───────────┘
       │
       │ 3. 更新 UI 狀態
       ▼
┌──────────────────────────────┐
│ setMerchants(data)           │
│ setIsMerchantsLoading(false) │
└──────┬───────────────────────┘
       │
       │ 4. React 重新渲染
       ▼
┌────────────────┐
│ 顯示商家列表   │
└────────────────┘
```

## 環境配置

```
開發環境                    生產環境
┌─────────────┐            ┌─────────────┐
│  .env.local │            │  .env.prod  │
└──────┬──────┘            └──────┬──────┘
       │                          │
       ▼                          ▼
REACT_APP_MERCHANTS_API_URL=     REACT_APP_MERCHANTS_API_URL=
localhost:3001                    https://api.production.com/prod
       │                          │
       ▼                          ▼
┌─────────────────┐        ┌─────────────────┐
│ 本地 API 服務器  │        │ AWS API Gateway │
└─────────────────┘        └─────────────────┘
```
